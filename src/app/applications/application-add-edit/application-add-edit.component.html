<div class="application-edit">
  <div class="container" *ngIf="application">
    <div class="title-container mb-4">
      <h1 class="title-container__title">Edit Application</h1>
      <div class="pg-title-container__actions">
        <a class="btn btn-light slide-l-btn" [routerLink]="['/a', application._id]">
          <i class="material-icons">info_outline</i>
          <span>Application Details</span>
        </a>
      </div>
    </div>

    <div class="row">
      <main class="col-lg-8">

        <!-- APPLICATION FORM -->
        <form class="mb-3" #applicationForm="ngForm">

          <!-- HEADER -->
          <section class="card bg-dark">
            <div class="title-container">
              <div class="title-container__title">
                  <h2 class="mb-0">{{application.client || '-'}}</h2>
                  <div>{{application.purpose || '-'}} / {{application.subpurpose || '-'}}</div>
              </div>
              <div class="title-container__actions">
                <button class="btn btn-light" type="button" (click)="selectClient()">
                  <span>{{application.client ? 'Change Client' : 'Select Client'}}</span>
                </button>
              </div>
            </div>
            <!--
            <h3>{{applicationService.getStatus(application) || '-'}}</h3>
            -->
            <ul class="application-edit__list">
              <li>CL File(s): {{application.cl_files ? application.cl_files.join(', ') : '-'}}</li>
              <li *ngIf="application.features?.length > 0">Disp ID: {{application.features[0].properties.DISPOSITION_TRANSACTION_SID}}</li>
            </ul>
          </section>

          <!-- DISPOSITION -->
          <section class="card bg-light">
            <h3>Disposition</h3>

            <div class="form-group">
              <h4 class="control-label mb-2" for="tantalisID">Disposition ID <em>(Required)</em></h4>
              <div class="disp-input" (keydown.enter)="false">
                <input type="number"
                  class="form-control"
                  [ngClass]="{'is-invalid': !tantalisID.valid && !tantalisID.untouched}"
                  id="tantalisID"
                  name="tantalisID"
                  required area-required="true"
                  [(ngModel)]="application.tantalisID"
                  #tantalisID="ngModel"
                  (keyup.enter)="applyDisposition()"
                  (keydown.arrowup)="$event.preventDefault()"
                  (keydown.arrowdown)="$event.preventDefault()"
                  (mousewheel)="$event.preventDefault()">
                <button type="button"
                  class="btn btn-primary float-left"
                  [disabled]="application.tantalisID === originalTantalisId"
                  (click)="applyDisposition()">
                  <i class="material-icons">system_update_alt</i>
                  <span>Fetch Disposition Data</span>
                </button>
                <div class="invalid-feedback">Disposition ID is required</div>
              </div>
            </div>
          </section>

          <!-- BASIC INFORMATION -->
          <section class="card bg-light" *ngIf="application.features && application.features.length > 0">
            <h3>Basic Information</h3>
            <ul class="application-edit__list">
              <li class="pt-0">
                <span class="name">Type / Subtype</span>
                <span class="value">{{application.features[0].properties.TENURE_TYPE || '-'}} / {{application.features[0].properties.TENURE_SUBTYPE
                  || '-'}}</span>
              </li>
              <li class="pt-0">
                <span class="name">Status</span>
                <span class="value">{{application.features[0].properties.TENURE_STATUS || '-'}}</span>
              </li>
              <li>
                <span class="name">Stage</span>
                <span class="value">{{application.features[0].properties.TENURE_STAGE || '-'}}</span>
              </li>
              <li>
                <span class="name">Agency</span>
                <span class="value">{{application.agency || '-'}}</span>
              </li>
            </ul>
            <hr>
            <ul class="application-edit__list">
              <li class="pt-0">
                <span class="name">Business Unit</span>
                <span class="value">{{application.features[0].properties.RESPONSIBLE_BUSINESS_UNIT || '-'}}</span>
              </li>
              <li class="pt-0">
                <span class="name">Region</span>
                <span class="value">{{application.region || '-'}}</span>
              </li>
              <li>
                <span class="name">Location</span>
                <span class="value">{{application.features[0].properties.TENURE_LOCATION || '-'}}</span>
              </li>
              <li>
                <span class="name">Total Area (hectares)</span>
                <span class="value">{{application.areaHectares ? (application.areaHectares | number:'1.2-2') : '-'}}</span>
              </li>
            </ul>
          </section>

          <!-- APPLICATION -->
          <section class="card bg-light">
            <h3>Application</h3>

            <section>
              <h4 class="control-label mb-2" for="description">
                Description <em>(Required)</em>
                <span ngbTooltip="Description is displayed publicly" placement="top"><i class="material-icons md-18">help</i></span>
              </h4>
              <textarea class="form-control app-desc"
                [ngClass]="{'is-invalid': !description.valid && !description.untouched}" type="text" id="description" name="description" rows="5" required aria-required="true" 
                [(ngModel)]="application.description"
                #description="ngModel">
              </textarea>
              <div class="invalid-feedback">Description is required</div>
            </section>
            
            <!-- Application Documents -->
            <section class="application-detail__documents">
              <h4 class="mb-2">Application Documents</h4>
              
              <div *ngIf="!application.documents || application.documents.length === 0">
                <em>This application has no documents.</em>
              </div>

              <ul class="document-list list-group mb-3">
                <li class="list-group-item" *ngFor="let file of application.documents">
                  <span class="cell icon pr-0">
                    <i class="material-icons">attachment</i>
                  </span>
                  <span class="cell name" [title]="file.displayName || ''">{{file.documentFileName}}</span>
                  <span class="cell actions">
                    <button class="btn btn-light p-1" (click)="api.downloadDocument(file)" title="Download this document">
                      <i class="material-icons">file_download</i>
                    </button>
                    <button class="btn btn-light p-1" (click)="api.openDocument(file)" title="Open this document">
                      <i class="material-icons">open_in_new</i>
                    </button>
                    <button class="btn btn-light p-1" *ngIf="!file.isPublished" (click)="deleteDocument(file, application.documents)"
                      title="Delete this document">
                      <i class="material-icons">delete</i>
                    </button>
                    <button class="btn btn-light p-1" *ngIf="!file.isPublished" (click)="publishDocument(file, application.documents)"
                      title="Publish this document">
                      <i class="material-icons">play_arrow</i>
                    </button>
                    <button class="btn btn-light p-1" type="button" *ngIf="file.isPublished" (click)="unPublishDocument(file, application.documents)"
                      title="Unpublish this document">
                      <i class="material-icons">pause</i>
                    </button>
                  </span>
                </li>
              </ul>

              <div class="dd-target">
                <button class="btn btn-light" type="button" onclick="document.getElementById('fileInput1').click()">
                  <i class="material-icons">file_upload</i>
                  <span><strong>Drag and Drop</strong> or <strong>Click to Browse</strong> Files to Upload</span>
                </button>
                <input type="file" id="fileInput1" style="display: none;" (change)="uploadFiles($event.target.files, application.documents)" multiple />
              </div>
            </section>

            <section>
              <h4 class="mb-2">
                Internal Notes
                <span ngbTooltip="Internal Notes are not displayed publicly" placement="top"><i class="material-icons md-18">help</i></span>
              </h4>
              <textarea class="form-control app-notes" type="text" id="internal.notes" name="internal.notes" rows="5" [(ngModel)]="application.internal.notes"></textarea>
            </section>

            <div class="section-form-btns mt-4">
              <!-- to save, application form must be valid -->
              <button class="btn btn-success" type="button" (click)="saveApplication()" [disabled]="!applicationForm.form.valid" title="Save application">
                <i class="material-icons">save</i>
                <span>Save</span>
              </button>
              <!-- to publish, application form must be valid -->
              <button class="btn btn-primary" type="button" *ngIf="!application.isPublished" (click)="publishApplication(application)"
                [disabled]="!applicationForm.form.valid" title="Publish application">
                <i class="material-icons">play_arrow</i>
                <span>Publish</span>
              </button>
              <button class="btn btn-danger" type="button" *ngIf="application.isPublished" (click)="unPublishApplication(application)" title="Un-publish application">
                <i class="material-icons">pause</i>
                <span>Unpublish</span>
              </button>
              <!-- to delete, there must be no application documents -->
              <button class="btn btn-danger" type="button" *ngIf="!application.isPublished" (click)="deleteApplication(application)" [disabled]="application.documents?.length > 0"
                title="Delete application">
                <i class="material-icons">delete</i>
                <span>Delete</span>
              </button>
            </div>

          </section>

        </form>

        <!-- ERROR MESSAGES FOR BOTH APPLICATION AND DECISION -->
        <div class="spinner-container full-screen" *ngIf="showMsg">
          <div *ngIf="error" class="alert alert-danger">{{status}}</div>
          <div *ngIf="!error" class="alert alert-success">{{status}}</div>
        </div>
        
        <!-- DECISION FORM -->
        <form class="mt-3" #decisionForm="ngForm">
          <section class="card bg-light">
            <h3 for="decisionDesc">Decision</h3>

            <section *ngIf="!application.decision">
              <button type="button" class="btn btn-success" (click)="addDecision()" title="Add decision">
                <i class="material-icons">add</i>
                <span>Add Decision</span>
              </button>
            </section>

            <!-- DECISION FORM ELEMENTS -->
            <div *ngIf="application.decision">
              <!-- Decision Description -->
              <section>
                <h4 class="control-label mb-2" for="decisionDesc">Description <em>(Required)</em></h4>
                <textarea class="form-control app-decision-desc" type="text" id="decisionDesc" name="decisionDesc" rows="5" 
                  [(ngModel)]="application.decision.description"
                  required 
                  aria-required="true" 
                  #decisionDesc="ngModel">
                </textarea>
              </section>

              <!-- Decision Documents -->
              <section>
                <h4 class="mb-2">Decision Documents</h4>

                <!--
                <div *ngIf="!application.decision.documents || application.decision.documents.length === 0">
                  <em>This decision has no documents.</em>
                </div>
                -->

                <ul class="document-list list-group mb-3" *ngIf="application.decision.documents.length > 0">
                  <li class="list-group-item" *ngFor="let file of application.decision.documents">
                    <span class="cell icon pr-0">
                      <i class="material-icons">attachment</i>
                    </span>
                    <span class="cell name" [title]="file.displayName || ''">{{file.documentFileName}}</span>
                    <span class="cell actions">
                      <button class="btn btn-light p-1" type="button" (click)="api.downloadDocument(file)" title="Download this document">
                        <i class="material-icons">file_download</i>
                      </button>
                      <button class="btn btn-light p-1" type="button" (click)="api.openDocument(file)" title="Open this document">
                        <i class="material-icons">open_in_new</i>
                      </button>
                      <button class="btn btn-light p-1" type="button" *ngIf="!file.isPublished" (click)="deleteDocument(file, application.decision.documents)"
                        title="Delete this document">
                        <i class="material-icons">delete</i>
                      </button>
                      <button class="btn btn-light p-1" type="button" *ngIf="!file.isPublished" (click)="publishDocument(file, application.decision.documents)"
                        title="Publish this document">
                        <i class="material-icons">play_arrow</i>
                      </button>
                      <button class="btn btn-light p-1" type="button" *ngIf="file.isPublished" (click)="unPublishDocument(file, application.decision.documents)"
                        title="Unpublish this document">
                        <i class="material-icons">pause</i>
                      </button>
                    </span>
                  </li>
                </ul>

                <div class="dd-target">
                  <button class="btn btn-light" onclick="document.getElementById('fileInput2').click()">
                    <i class="material-icons">file_upload</i>
                    <span><strong>Drag and Drop</strong> or <strong>Click to Browse</strong> Files to Upload</span>
                  </button>
                  <input type="file" id="fileInput2" style="display: none;" (change)="uploadFiles($event.target.files, application.decision.documents)" multiple />
                </div>
              </section>

              <!-- Decision Form Buttons -->
              <div class="section-form-btns mt-4">
                <!-- to save, decision form must be valid -->
                <button class="btn btn-success" type="button" (click)="saveDecision()" [disabled]="!decisionForm.form.valid" title="Save decision">
                  <i class="material-icons">save</i>
                  <span>Save</span>
                </button>
                <!-- to publish, decision form must be valid -->
                <button class="btn btn-primary" type="button" *ngIf="!application.decision.isPublished" (click)="publishDecision(application.decision)"
                  [disabled]="!decisionForm.form.valid" title="Publish decision">
                  <i class="material-icons">play_arrow</i>
                  <span>Publish</span>
                </button>
                <button class="btn btn-danger" type="button" *ngIf="application.decision.isPublished" (click)="unPublishDecision(application.decision)"
                  title="Unpublish decision">
                  <i class="material-icons">pause</i>
                  <span>Unpublish</span>
                </button>
                <!-- to delete, there must be no decision documents -->
                <button class="btn btn-danger" type="button" *ngIf="!application.decision.isPublished" (click)="deleteDecision(application.decision)"
                  [disabled]="application.decision.documents?.length > 0" title="Delete decision">
                  <i class="material-icons">delete</i>
                  <span>Delete</span>
                </button>
              </div>
            </div>
          </section>
        </form>

        <!-- GEOGRAPHIC SHAPE DATA -->
        <section class="geo-shape-data card bg-light">
          <div class="title-container">
            <h3 class="title-container__title mb-0">Geographic Shape Data</h3>
            <div class="title-container__actions">
              <button class="btn btn-white slide-r-btn" (click)="launchMap()" disabled aria-disabled="true">
                <span>See on map</span>
                <i class="material-icons">place</i>
              </button>
            </div>
          </div>
          <span *ngIf="application.features">This application has
            <strong>{{application.features.length}}</strong> shape {{application.features.length === 1 ? 'file' : 'files'}}.</span>
          <div class="geo-shape-data__list">
            <section class="pt-3" *ngFor="let shape of application.features">
              <h4 class="mb-3">Interest ID: {{shape.properties.INTRID_SID}}</h4>
              <ul class="application-edit__list">
                <li class="pt-0">
                  <span class="name">Type/Subtype</span>
                  <span class="value">{{shape.properties.TENURE_TYPE}}/{{shape.properties.TENURE_SUBTYPE}}</span>
                </li>
                <li class="pt-0">
                  <span class="name">Area (ha)</span>
                  <span class="value">
                    {{shape.properties.TENURE_AREA_IN_HECTARES ? (shape.properties.TENURE_AREA_IN_HECTARES | number:'1.2-2') : '-'}}
                  </span>
                </li>
                <li class="full-width">
                  <span class="name">Legal Description</span>
                  <span class="value">{{shape.properties.TENURE_LEGAL_DESCRIPTION}}</span>
                </li>
              </ul>
            </section>
          </div>
        </section>

      </main>

      <aside class="col-lg-4">
        <app-application-aside></app-application-aside>
      </aside>

    </div>
  </div>
</div>